/**
* Keybind.js
*
* Version: 0.1
* Author: Atshi.com
* Description: Library for creating keybindings within any web application.
*
* Copyright (C) 2013 Atshi
*
* License: MIT
*/
!function(){var a,b,c,d={}.hasOwnProperty;c=function(){function a(){}return a.typeIsArray=function(a){return a&&"object"==typeof a&&a instanceof Array&&"number"==typeof a.length&&"function"==typeof a.splice&&!a.propertyIsEnumerable("length")},a.cloneObject=function(a){var b,c,e;if("string"==typeof a||"number"==typeof a)return a;c=this.typeIsArray(a)?[]:{};for(b in a)d.call(a,b)&&(e=a[b],c[b]=a[b]&&"object"==typeof a[b]?this.cloneObject(a[b]):a[b]);return c},a.mergeInto=function(a,b){var c,e,f;f=[];for(c in a)d.call(a,c)&&(e=a[c],null!=b[c]?this.typeIsArray(b[c])&&b[c].length>0?f.push(b[c]=b[c].concat(a[c])):f.push(this.mergeInto(a[c],b[c])):f.push(b[c]=this.cloneObject(a[c])));return f},a.safePush=function(a,b,c){return null==a[b]&&(a[b]=[]),a[b].push(c)},a.getAndCreate=function(a,b){return null==a[b]&&(a[b]=[]),a[b]},a}(),b=function(){function a(){}return a.TIMEOUT=300,a.keybindings=[],a.globalkeybindings=[],a.modevalues=[],a.initiated=!1,a.storedCount="",a.timeoutInterval=null,a.mode=null,a.keysDown=[],a.currentMatches=null,a.Keys={TAB:9,SHIFT:16,CTRL:17,ALT:18,CAPS_LOCK:20,ESCAPE:27,CMD_LEFT:91,CMD_RIGHT:93,ZERO:"0".charCodeAt(0),NINE:"9".charCodeAt(0)},a.modifiers={"<TAB>":a.Keys.TAB,"<SHIFT>":a.Keys.SHIFT,"<S>":a.Keys.SHIFT,"<CTRL>":a.Keys.CTRL,"<C>":a.Keys.CTRL,"<ALT>":a.Keys.ALT,"<CAPS_LOCK>":a.Keys.CAPS_LOCK,"<CAPSLOCK>":a.Keys.CAPS_LOCK,"<ESCAPE>":a.Keys.ESCAPE,"<ESC>":a.Keys.ESCAPE,"<CMD_LEFT>":a.Keys.CMD_LEFT,"<CMDLEFT>":a.Keys.CMD_LEFT,"<CMDL>":a.Keys.CMD_LEFT,"<CMD_RIGHT>":a.Keys.CMD_RIGHT,"<CMDRIGHT>":a.Keys.CMD_RIGHT,"<CMDR>":a.Keys.CMD_RIGHT},a.init=function(){var a,b,e;if(!this.initiated){this.initiated=!0,this.reversedModifiers=[],e=this.modifiers;for(a in e)d.call(e,a)&&(b=e[a],c.safePush(this.reversedModifiers,b,a));if(document.attachEvent)return document.attachEvent("onkeyup",function(){return this.onKeyUp}),document.attachEvent("onkeydown",function(){return this.onKeyDown});if(document.addEventListener)return document.addEventListener("keyup",this.onKeyUp,!1),document.addEventListener("keydown",this.onKeyDown,!1)}},a.setMode=function(a){return this.mode=a,this.updateKeybindings()},a.getMode=function(){return this.mode},a.getKeybindings=function(){var a,b,e,f;b=c.cloneObject(this.globalkeybindings),f=this.modevalues;for(a in f)d.call(f,a)&&(e=f[a],c.mergeInto(this.modevalues[a],b));return b},a.getCurrentKeybindings=function(){return this.keybindings},a.updateKeybindings=function(){return this.keybindings=c.cloneObject(this.globalkeybindings),this.mode&&null!=this.modevalues[this.mode]?c.mergeInto(this.modevalues[this.mode],this.keybindings):void 0},a.onKeyUp=function(b){return delete a.keysDown[b.keyCode]},a.onKeyDown=function(b){return a.keysDown[b.keyCode]=!0,a.addToSequence(b.keyCode)},a.tryRule=function(a){var b,c,d,e;if(a){for(c=this.getKeycodes(a),d=0,e=c.length;e>d;d++)if(b=c[d],null!=this.keysDown[b]&&this.keysDown[b])return!0;return!1}return!0},a.getKeycodes=function(a){return null!=this.modifiers[a]?[this.modifiers[a]]:[a.charCodeAt(0)]},a.getChars=function(a){return null!=this.reversedModifiers[a]?this.reversedModifiers[a]:[String.fromCharCode(a)]},a.addToSequence=function(a){var b,e,f,g,h,i,j,k,l,m,n,o;if(null!=this.timeoutInterval&&(clearTimeout(this.timeoutInterval),this.timeoutInterval=null),null==this.currentMatches&&a>=this.Keys.ZERO&&a<=this.Keys.NINE)return this.storedCount+=String.fromCharCode(a);for(null==this.currentMatches&&(this.currentMatches=this.keybindings,this.matchIndex=0),e=this.getChars(a),j=[],f=[],g=!1,this.matchIndex++,m=0,n=e.length;n>m;m++){b=e[m],o=this.currentMatches[b];for(h in o)d.call(o,h)&&(i=o[h],l=i.getSequence(),l.length>this.matchIndex?this.tryRule(i.getRule(this.matchIndex))&&(k=l[this.matchIndex],c.safePush(j,k,i),g=!0):this.tryRule(i.getRule(this.matchIndex-1))&&f.push(i))}return g?(this.currentMatches=j,this.currentExactMatches=f,this.timeoutInterval=setTimeout(this.executeMatches.bind(this,this.currentExactMatches),this.TIMEOUT)):(this.currentMatches=null,f.length>0?this.executeMatches(f):null!=this.currentExactMatches&&this.currentExactMatches.length>0?(this.executeMatches(this.currentExactMatches),this.addToSequence(a)):this.currentExactMatches=null)},a.executeMatches=function(a){var b,c,d,e;if(b=Math.max(1,parseInt(this.storedCount)),this.storedCount="",b||(b=1),null!=a)for(d=0,e=a.length;e>d;d++)c=a[d],c.getAction().call(window,b,c.getShortcut(),c.getDescription());return null!=this.timeoutInterval&&(clearTimeout(this.timeoutInterval),this.timeoutInterval=null),this.currentExactMatches=null,this.currentMatches=null},a.register=function(a){var b,d;return b=a.getMode()?c.getAndCreate(this.modevalues,a.getMode()):this.globalkeybindings,d=a.getSequence(),d.length>0&&c.safePush(b,d[0],a),this.updateKeybindings()},a.unregister=function(a){var b,c,d,e;return d=a.getMode()?this.modevalues[a.getMode()]:this.globalkeybindings,e=a.getSequence(),b=e[0],c=d[b].indexOf(a),d[b].splice(c,1),this.updateKeybindings()},a}.call(this),a=function(){function a(a,c,d,e){var f,g,h,i,j,k,l;for(i=a.toUpperCase().match(/(?:<.+>|.)\+.|<.+>|./g),h=[],f=k=0,l=i.length;l>k;f=++k)g=i[f],j=g.split("+"),j.length>1&&(h[f]=j[0],i[f]=j[1]);this.getRule=function(a){return h[a]},this.getSequence=function(){return i},this.getShortcut=function(){return a},this.getDescription=function(){return d},this.getAction=function(){return c},this.getMode=function(){return e},b.init(),b.register(this)}return a.prototype.remove=function(){return b.unregister(this)},a.setMode=function(a){return b.setMode(a)},a.getMode=function(){return b.getMode()},a.getRegistered=function(){var a,c,e,f,g,h,i;f=[],i=b.getKeybindings();for(c in i)if(d.call(i,c))for(a=i[c],g=0,h=a.length;h>g;g++)e=a[g],f.push(e);return f},a}(),window.Keybinding=a}.call(this);